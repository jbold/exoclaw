# Implementation Plan: Onboarding & Built-in Chat UI

**Branch**: `002-onboard-chat-ui` | **Date**: 2026-02-08 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-onboard-chat-ui/spec.md`

## Summary

Add two UX essentials missing from the core runtime: (1) a CLI onboarding command (`exoclaw onboard`) that securely stores API keys with proper file permissions, and (2) a Leptos-based web chat interface served at `/` that lets users talk to their agent through a browser with streamed markdown responses. Together, these make SC-006 ("install to first message in 5 minutes") achievable.

## Technical Context

**Language/Version**: Rust 2024 edition (existing), Leptos 0.8 (new)
**Primary Dependencies**: axum 0.8 (existing), leptos 0.8 + leptos_axum (new), gloo-net (new, WASM WebSocket client), pulldown-cmark (new, WASM markdown), rpassword 7 (already added in uncommitted code)
**Storage**: Filesystem only — `~/.exoclaw/credentials/` for keys, `~/.exoclaw/config.toml` for config
**Testing**: `cargo test` (existing), browser-based manual testing for UI
**Target Platform**: Linux/macOS server (binary) + modern browsers (WASM)
**Project Type**: Cargo workspace — server binary + Leptos UI lib crate
**Performance Goals**: Chat page load < 500ms including WASM hydration, token rendering < 50ms overhead
**Constraints**: No npm/JS build tools. Binary under 25MB (constitution). Leptos WASM bundle served from same process.
**Scale/Scope**: Single-user localhost. Not multi-tenant.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Secure by Default | PASS | API keys stored with 0600 perms, never in config file, env var precedence. Chat UI uses existing WebSocket auth (constant-time token comparison). No new trust boundaries introduced. |
| II. Cost-Aware by Architecture | PASS | No impact on token metering. Chat UI is a thin client — all metering/budgets enforced server-side. |
| III. Simple Configuration | PASS | `exoclaw onboard` makes setup *simpler* than the constitution requires. Config file stays single TOML. |
| IV. WASM-First Plugin Model | PASS | Chat UI is NOT a plugin — it's the host's own frontend. It compiles to browser WASM (wasm32-unknown-unknown) but runs in the browser, not in the Extism sandbox. No confusion with the plugin model. |
| V. Performance Without Compromise | PASS | Server binary grows ~1-2 MB (well under 25MB). WASM bundle ~50-100KB gzipped. Page load < 500ms (SC-003). Token rendering overhead < 50ms via fine-grained reactivity (SC-004). Startup not affected. |
| Development Workflow | MINOR CHANGE | Build command changes from `cargo build` to `cargo leptos build`. `cargo check/test/clippy/fmt` unchanged. CI needs `cargo install cargo-leptos`. |

**Gate result**: PASS — no violations. Minor workflow change documented.

## Project Structure

### Documentation (this feature)

```text
specs/002-onboard-chat-ui/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Technology decisions
├── data-model.md        # Entity schemas
├── quickstart.md        # Getting started guide
├── contracts/
│   └── routes.md        # HTTP route contracts
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
Cargo.toml                    # Workspace root (converted from single crate)
├── src/                      # Existing server binary (workspace member "exoclaw")
│   ├── main.rs               # CLI: onboard, gateway, plugin, status
│   ├── lib.rs                # Module exports
│   ├── config.rs             # Config + save() + resolve_api_key() (partially done)
│   ├── secrets.rs            # Credential store (partially done)
│   ├── gateway/
│   │   ├── server.rs         # axum server — add Leptos route integration here
│   │   ├── protocol.rs       # JSON-RPC dispatch (unchanged)
│   │   └── auth.rs           # Token verification (unchanged)
│   ├── agent/                # LLM streaming (unchanged)
│   ├── router/               # Session routing (unchanged)
│   ├── sandbox/              # WASM plugin host (unchanged)
│   ├── bus/                  # NATS (unchanged)
│   ├── store/                # Session store (unchanged)
│   ├── memory/               # Memory engine (unchanged)
│   └── types.rs              # Shared types (unchanged)
│
├── ui/                       # NEW: Leptos frontend crate (workspace member "exoclaw-ui")
│   ├── Cargo.toml            # leptos, gloo-net, pulldown-cmark, serde_json
│   └── src/
│       ├── lib.rs            # Crate root, re-exports
│       ├── app.rs            # Root App component + Leptos router
│       └── components/
│           ├── mod.rs
│           ├── chat.rs       # Main chat container (message list + input)
│           ├── message.rs    # Single message bubble (markdown rendering)
│           ├── input.rs      # Message input with send button + disable-while-streaming
│           ├── auth_prompt.rs # Token entry dialog (shown when gateway requires auth)
│           └── status.rs     # Connection status indicator
│
├── examples/echo-plugin/     # Existing (unchanged)
├── examples/mock-channel/    # Existing (unchanged)
├── tests/                    # Existing integration tests (unchanged)
└── benches/                  # Existing benchmarks (unchanged)
```

**Structure Decision**: Cargo workspace with the existing server as root member and `ui/` as a separate library crate. This cleanly separates server-only dependencies (extism, async-nats, reqwest) from browser-only dependencies (gloo-net, web-sys) without fragile `#[cfg(feature)]` gating.

## Complexity Tracking

No constitution violations requiring justification.

## Implementation Notes

### US1: Onboarding (Partially Complete)

The uncommitted code on `main` already implements most of US1:
- `src/secrets.rs` — credential store with read/write/permissions, 2 unit tests
- `src/main.rs` — `exoclaw onboard` CLI command with provider selection + rpassword input
- `src/config.rs` — `save()`, `save_to_path()`, `resolve_path()`, `Serialize` derives, credential file fallback in `resolve_api_key()`
- `Cargo.toml` — `rpassword = "7"` dependency

**Remaining work for US1**: Tests for the full onboard flow (integration tests), verify re-onboard preserves unrelated config, update CLAUDE.md/README.

### US2: Chat UI (New)

Requires:
1. Convert project to Cargo workspace
2. Create `ui/` crate with Leptos components
3. Integrate Leptos serving into `gateway/server.rs`
4. WebSocket client in WASM (gloo-net → JSON-RPC)
5. Markdown rendering (pulldown-cmark)
6. Input disable-while-streaming behavior
7. Auth token prompt
8. Connection status / error display
9. Update build tooling (`cargo-leptos`)

### Dependencies Between Stories

US1 (Onboarding) and US2 (Chat UI) are independent — they can be implemented in parallel. US2 depends on 001-core-runtime's `chat.send` being wired (currently stubbed), but the UI can be built and tested against the stub or a mock.
